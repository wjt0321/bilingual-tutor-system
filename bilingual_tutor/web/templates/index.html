{% extends "base.html" %}

{% block title %}é¦–é¡µ - åŒè¯­å¯¼å¸ˆç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Welcome Section -->
    <section class="welcome-section">
        <div class="welcome-content">
            <h1>æ¬¢è¿å›æ¥ï¼Œ<span id="userName">{{ user_id }}</span>ï¼</h1>
            <p class="welcome-subtitle">ä»Šå¤©æ˜¯å­¦ä¹ çš„å¥½æ—¥å­ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ï¼</p>
        </div>
        <div class="quick-stats" id="quickStats">
            <div class="stat-card">
                <span class="stat-icon">ğŸ‡¬ğŸ‡§</span>
                <span class="stat-label">è‹±è¯­æ°´å¹³</span>
                <span class="stat-value" id="englishLevel">--</span>
            </div>
            <div class="stat-card">
                <span class="stat-icon">ğŸ‡¯ğŸ‡µ</span>
                <span class="stat-label">æ—¥è¯­æ°´å¹³</span>
                <span class="stat-value" id="japaneseLevel">--</span>
            </div>
            <div class="stat-card">
                <span class="stat-icon">â°</span>
                <span class="stat-label">æ¯æ—¥æ—¶é—´</span>
                <span class="stat-value" id="dailyTime">-- åˆ†é’Ÿ</span>
            </div>
        </div>
    </section>

    <!-- Today's Plan Section -->
    <section class="today-plan">
        <div class="section-header">
            <h2>ğŸ“‹ ä»Šæ—¥å­¦ä¹ è®¡åˆ’</h2>
            <button class="btn-primary" onclick="startLearning()">å¼€å§‹å­¦ä¹ </button>
        </div>

        <div class="plan-overview" id="planOverview">
            <div class="time-allocation">
                <div class="time-block review">
                    <span class="time-icon">ğŸ”„</span>
                    <span class="time-label">å¤ä¹ </span>
                    <span class="time-value" id="reviewTime">-- åˆ†é’Ÿ</span>
                </div>
                <div class="time-block english">
                    <span class="time-icon">ğŸ‡¬ğŸ‡§</span>
                    <span class="time-label">è‹±è¯­</span>
                    <span class="time-value" id="englishTime">-- åˆ†é’Ÿ</span>
                </div>
                <div class="time-block japanese">
                    <span class="time-icon">ğŸ‡¯ğŸ‡µ</span>
                    <span class="time-label">æ—¥è¯­</span>
                    <span class="time-value" id="japaneseTime">-- åˆ†é’Ÿ</span>
                </div>
            </div>
        </div>

        <div class="activities-list" id="activitiesList">
            <!-- Activities will be loaded dynamically -->
            <div class="loading">æ­£åœ¨åŠ è½½å­¦ä¹ è®¡åˆ’...</div>
        </div>

        <div class="objectives-section">
            <h3>ğŸ“š ä»Šæ—¥å­¦ä¹ ç›®æ ‡</h3>
            <ul class="objectives-list" id="objectivesList">
                <!-- Objectives will be loaded dynamically -->
            </ul>
        </div>
    </section>

    <!-- Progress Overview -->
    <section class="progress-overview">
        <div class="section-header">
            <h2>ğŸ“Š å­¦ä¹ è¿›åº¦æ¦‚è§ˆ</h2>
            <a href="{{ url_for('main.progress_page') }}" class="btn-secondary">æŸ¥çœ‹è¯¦æƒ…</a>
        </div>

        <div class="progress-cards">
            <div class="progress-card">
                <h4>è‹±è¯­è¯æ±‡</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="englishVocabProgress" style="width: 0%"></div>
                </div>
                <span class="progress-text" id="englishVocabText">å·²æŒæ¡ 0 ä¸ª</span>
            </div>
            <div class="progress-card">
                <h4>æ—¥è¯­è¯æ±‡</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="japaneseVocabProgress" style="width: 0%"></div>
                </div>
                <span class="progress-text" id="japaneseVocabText">å·²æŒæ¡ 0 ä¸ª</span>
            </div>
            <div class="progress-card">
                <h4>å­¦ä¹ å†…å®¹</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="contentProgress" style="width: 0%"></div>
                </div>
                <span class="progress-text" id="contentText">å·²å­¦ä¹  0 ä¸ª</span>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<!-- Include enhanced JavaScript modules -->
<script src="{{ url_for('static', filename='js/progress.js') }}"></script>

<script>
    // Enhanced dashboard functionality
    class DashboardManager {
        constructor() {
            this.progressViz = null;
            this.init();
        }
        
        init() {
            this.loadUserProfile();
            this.loadLearningPlan();
            this.loadProgress();
            this.initProgressVisualization();
        }
        
        initProgressVisualization() {
            // Initialize mini progress visualization for dashboard
            this.progressViz = new ProgressVisualization();
        }

        async loadUserProfile() {
            try {
                const profile = await BilingualTutor.loadUserProfile();
                if (profile) {
                    BilingualTutor.setText('englishLevel', profile.english_level);
                    BilingualTutor.setText('japaneseLevel', profile.japanese_level);
                    BilingualTutor.setText('dailyTime', profile.daily_study_time + ' åˆ†é’Ÿ');
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
                BilingualTutor.showToast('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥', 'error');
            }
        }

        async loadLearningPlan() {
            try {
                const plan = await BilingualTutor.loadLearningPlan();
                if (plan) {
                    // Update time allocation with enhanced animations
                    this.animateTimeUpdate('reviewTime', plan.review_time + ' åˆ†é’Ÿ');
                    this.animateTimeUpdate('englishTime', plan.english_time + ' åˆ†é’Ÿ');
                    this.animateTimeUpdate('japaneseTime', plan.japanese_time + ' åˆ†é’Ÿ');

                    // Update activities list with enhanced cards
                    const activitiesList = document.getElementById('activitiesList');
                    if (plan.activities && plan.activities.length > 0) {
                        activitiesList.innerHTML = plan.activities.map((activity, index) => `
                            <div class="activity-card enhanced-card" data-id="${activity.id}">
                                <div class="activity-number">${index + 1}</div>
                                <div class="activity-info">
                                    <span class="activity-type ${activity.language}">${activity.language_display}</span>
                                    <span class="activity-name">${BilingualTutor.getActivityTypeName(activity.type)}</span>
                                    <span class="activity-difficulty">${this.getDifficultyText(activity.difficulty)}</span>
                                </div>
                                <div class="activity-meta">
                                    <div class="activity-duration">â±ï¸ ${activity.duration} åˆ†é’Ÿ</div>
                                    <div class="activity-points">ğŸ¯ ${activity.estimated_points || 10} åˆ†</div>
                                </div>
                                <div class="activity-status pending">å¾…å®Œæˆ</div>
                            </div>
                        `).join('');
                        
                        // Add click handlers for enhanced interaction
                        this.bindActivityCardEvents();
                    } else {
                        activitiesList.innerHTML = '<div class="loading">æš‚æ— å­¦ä¹ æ´»åŠ¨</div>';
                    }

                    // Update objectives with progress indicators
                    const objectivesList = document.getElementById('objectivesList');
                    if (plan.objectives && plan.objectives.length > 0) {
                        objectivesList.innerHTML = plan.objectives.map((obj, index) => `
                            <li class="objective-item">
                                <span class="objective-icon">ğŸ“Œ</span>
                                <span class="objective-text">${obj}</span>
                                <span class="objective-progress">0%</span>
                            </li>
                        `).join('');
                    } else {
                        objectivesList.innerHTML = '<li class="objective-item">ä»Šæ—¥æš‚æ— ç‰¹å®šç›®æ ‡</li>';
                    }
                }
            } catch (error) {
                console.error('Failed to load plan:', error);
                document.getElementById('activitiesList').innerHTML = '<div class="error">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</div>';
            }
        }

        async loadProgress() {
            try {
                const progress = await BilingualTutor.loadProgress();
                if (progress) {
                    const vocab = progress.vocabulary || {};
                    const content = progress.content_history || {};

                    // Update English vocabulary with enhanced animations
                    const engMastered = vocab.english?.mastered || 0;
                    const engTotal = vocab.english?.total || 100;
                    const engProgress = Math.min((engMastered / engTotal) * 100, 100);
                    
                    BilingualTutor.setText('englishVocabText', `å·²æŒæ¡ ${engMastered}/${engTotal} ä¸ª`);
                    this.animateProgressBar('englishVocabProgress', engProgress);

                    // Update Japanese vocabulary with enhanced animations
                    const jpnMastered = vocab.japanese?.mastered || 0;
                    const jpnTotal = vocab.japanese?.total || 100;
                    const jpnProgress = Math.min((jpnMastered / jpnTotal) * 100, 100);
                    
                    BilingualTutor.setText('japaneseVocabText', `å·²æŒæ¡ ${jpnMastered}/${jpnTotal} ä¸ª`);
                    this.animateProgressBar('japaneseVocabProgress', jpnProgress);

                    // Update content learned with enhanced display
                    const contentCount = content.total_content_seen || 0;
                    const contentTarget = content.daily_target || 10;
                    const contentProgress = Math.min((contentCount / contentTarget) * 100, 100);
                    
                    BilingualTutor.setText('contentText', `å·²å­¦ä¹  ${contentCount}/${contentTarget} ä¸ª`);
                    this.animateProgressBar('contentProgress', contentProgress);
                }
            } catch (error) {
                console.error('Failed to load progress:', error);
            }
        }
        
        animateTimeUpdate(elementId, newValue) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.transform = 'scale(1.1)';
                element.style.transition = 'transform 0.3s ease';
                BilingualTutor.setText(elementId, newValue);
                
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                }, 300);
            }
        }
        
        animateProgressBar(elementId, percentage) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.transition = 'width 1s ease-in-out';
                BilingualTutor.updateProgressBar(elementId, percentage);
            }
        }
        
        getDifficultyText(difficulty) {
            const levels = {
                'easy': 'ç®€å•',
                'medium': 'ä¸­ç­‰',
                'hard': 'å›°éš¾'
            };
            return levels[difficulty] || 'ä¸­ç­‰';
        }
        
        bindActivityCardEvents() {
            const activityCards = document.querySelectorAll('.activity-card');
            activityCards.forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.activity-status')) {
                        this.previewActivity(card.dataset.id);
                    }
                });
                
                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-2px)';
                    card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                });
                
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'translateY(0)';
                    card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                });
            });
        }
        
        previewActivity(activityId) {
            // Show activity preview modal or navigate to activity
            BilingualTutor.showToast(`é¢„è§ˆæ´»åŠ¨ ${activityId}`, 'info');
        }
    }

    // Initialize dashboard when DOM is loaded
    document.addEventListener('DOMContentLoaded', function () {
        window.dashboardManager = new DashboardManager();
    });

    function startLearning() {
        BilingualTutor.navigateTo('/learn');
    }
</script>
{% endblock %}