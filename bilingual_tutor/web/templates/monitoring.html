<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á≥ªÁªüÁõëÊéß‰ª™Ë°®Êùø - ÂèåËØ≠ÂØºÂ∏àÁ≥ªÁªü</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .monitoring-dashboard {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-header h1 {
            margin: 0;
            color: var(--primary);
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .status-badge.healthy {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-badge.degraded {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-badge.unhealthy {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .metric-card.warning {
            border-color: var(--warning);
        }

        .metric-card.critical {
            border-color: var(--error);
        }

        .metric-card h3 {
            margin: 0 0 10px 0;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .metric-value.warning {
            color: var(--warning);
        }

        .metric-value.critical {
            color: var(--error);
        }

        .metric-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .metric-stat {
            display: flex;
            flex-direction: column;
        }

        .metric-stat span:first-child {
            font-weight: 600;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .chart-card h3 {
            margin: 0 0 15px 0;
            color: var(--text-secondary);
            font-size: 16px;
        }

        .alerts-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .alerts-section h3 {
            margin: 0 0 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alerts-count {
            background: var(--error);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        .alert-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 12px;
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-item.info {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid var(--primary);
        }

        .alert-item.warning {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--warning);
        }

        .alert-item.critical {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--error);
        }

        .alert-icon {
            font-size: 24px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-message {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .alert-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .alert-actions {
            display: flex;
            gap: 8px;
        }

        .btn-resolve {
            padding: 6px 12px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-resolve:hover {
            opacity: 0.9;
        }

        .health-checks {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .health-check-item {
            padding: 15px;
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .health-check-item.healthy {
            background: rgba(16, 185, 129, 0.1);
        }

        .health-check-item.unhealthy {
            background: rgba(239, 68, 68, 0.1);
        }

        .health-check-item.error {
            background: rgba(156, 163, 175, 0.1);
        }

        .health-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .health-status.healthy {
            background: var(--success);
        }

        .health-status.unhealthy {
            background: var(--error);
        }

        .health-status.error {
            background: var(--text-muted);
        }

        .health-check-name {
            font-weight: 600;
            font-size: 14px;
        }

        .health-check-message {
            font-size: 12px;
            color: var(--text-muted);
        }

        .refresh-indicator {
            display: none;
            margin-left: 10px;
            color: var(--text-muted);
        }

        .refresh-indicator.active {
            display: inline;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }

            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .metric-value {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="monitoring-dashboard">
        <div class="dashboard-header">
            <h1>Á≥ªÁªüÁõëÊéß‰ª™Ë°®Êùø</h1>
            <div>
                <span id="status-badge" class="status-badge">Âä†ËΩΩ‰∏≠...</span>
                <span class="refresh-indicator" id="refresh-indicator">Âà∑Êñ∞‰∏≠...</span>
            </div>
        </div>

        <div class="metrics-grid" id="metrics-grid">
            <div class="metric-card">
                <h3>CPU‰ΩøÁî®Áéá</h3>
                <div class="metric-value" id="cpu-value">-</div>
                <div class="metric-stats">
                    <div class="metric-stat">
                        <span id="cpu-min">-</span>
                        <span>ÊúÄÂ∞è</span>
                    </div>
                    <div class="metric-stat">
                        <span id="cpu-max">-</span>
                        <span>ÊúÄÂ§ß</span>
                    </div>
                    <div class="metric-stat">
                        <span id="cpu-avg">-</span>
                        <span>Âπ≥Âùá</span>
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <h3>ÂÜÖÂ≠ò‰ΩøÁî®Áéá</h3>
                <div class="metric-value" id="memory-value">-</div>
                <div class="metric-stats">
                    <div class="metric-stat">
                        <span id="memory-min">-</span>
                        <span>ÊúÄÂ∞è</span>
                    </div>
                    <div class="metric-stat">
                        <span id="memory-max">-</span>
                        <span>ÊúÄÂ§ß</span>
                    </div>
                    <div class="metric-stat">
                        <span id="memory-avg">-</span>
                        <span>Âπ≥Âùá</span>
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <h3>Á£ÅÁõò‰ΩøÁî®Áéá</h3>
                <div class="metric-value" id="disk-value">-</div>
                <div class="metric-stats">
                    <div class="metric-stat">
                        <span id="disk-min">-</span>
                        <span>ÊúÄÂ∞è</span>
                    </div>
                    <div class="metric-stat">
                        <span id="disk-max">-</span>
                        <span>ÊúÄÂ§ß</span>
                    </div>
                    <div class="metric-stat">
                        <span id="disk-avg">-</span>
                        <span>Âπ≥Âùá</span>
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <h3>Êï∞ÊçÆÂ∫ìÂìçÂ∫îÊó∂Èó¥</h3>
                <div class="metric-value" id="db-value">-</div>
                <div class="metric-stats">
                    <div class="metric-stat">
                        <span id="db-min">-</span>
                        <span>ÊúÄÂ∞è</span>
                    </div>
                    <div class="metric-stat">
                        <span id="db-max">-</span>
                        <span>ÊúÄÂ§ß</span>
                    </div>
                    <div class="metric-stat">
                        <span id="db-avg">-</span>
                        <span>Âπ≥Âùá</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-card">
                <h3>CPU‰ΩøÁî®ÁéáË∂ãÂäø</h3>
                <canvas id="cpu-chart"></canvas>
            </div>
            <div class="chart-card">
                <h3>ÂÜÖÂ≠ò‰ΩøÁî®ÁéáË∂ãÂäø</h3>
                <canvas id="memory-chart"></canvas>
            </div>
        </div>

        <div class="alerts-section">
            <h3>
                Ê¥ªÂä®ÂëäË≠¶
                <span class="alerts-count" id="alerts-count">0</span>
            </h3>
            <div class="alert-list" id="alert-list">
            </div>
        </div>

        <div class="chart-card" style="margin-bottom: 30px;">
            <h3>Á≥ªÁªüÂÅ•Â∫∑Ê£ÄÊü•</h3>
            <div class="health-checks" id="health-checks">
            </div>
        </div>
    </div>

    <script>
        let cpuChart = null;
        let memoryChart = null;
        let updateInterval = null;

        async function fetchDashboardData() {
            try {
                const response = await fetch('/api/monitoring/dashboard');
                const data = await response.json();
                
                if (data.success) {
                    updateDashboard(data.data);
                }
            } catch (error) {
                console.error('Ëé∑Âèñ‰ª™Ë°®ÊùøÊï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }

        function updateDashboard(data) {
            // Êõ¥Êñ∞Áä∂ÊÄÅ
            const statusBadge = document.getElementById('status-badge');
            statusBadge.textContent = data.health_status.status === 'healthy' ? 'ÂÅ•Â∫∑' :
                                 data.health_status.status === 'degraded' ? 'ÈôçÁ∫ß' : 'ÂºÇÂ∏∏';
            statusBadge.className = `status-badge ${data.health_status.status}`;

            // Êõ¥Êñ∞ÊåáÊ†á
            updateMetric('cpu', data.performance_metrics.cpu_usage);
            updateMetric('memory', data.performance_metrics.memory_usage);
            updateMetric('disk', data.performance_metrics.disk_usage);
            updateMetric('db', data.performance_metrics.db_response_time);

            // Êõ¥Êñ∞ÂõæË°®
            updateCharts(data.performance_metrics);

            // Êõ¥Êñ∞ÂëäË≠¶
            updateAlerts(data.active_alerts, data.recent_alerts);

            // Êõ¥Êñ∞ÂÅ•Â∫∑Ê£ÄÊü•
            updateHealthChecks(data.health_status.checks);
        }

        function updateMetric(name, stats) {
            if (!stats || stats.current === undefined) return;

            const valueEl = document.getElementById(`${name}-value`);
            const minEl = document.getElementById(`${name}-min`);
            const maxEl = document.getElementById(`${name}-max`);
            const avgEl = document.getElementById(`${name}-avg`);

            const currentValue = stats.current.toFixed(1);
            valueEl.textContent = name === 'db' ? `${stats.current.toFixed(3)}s` : `${currentValue}%`;
            
            if (name !== 'db' && stats.current > 80) {
                valueEl.classList.add('critical');
            } else if (name !== 'db' && stats.current > 60) {
                valueEl.classList.add('warning');
            } else {
                valueEl.classList.remove('warning', 'critical');
            }

            if (stats.min !== undefined) minEl.textContent = stats.min.toFixed(1);
            if (stats.max !== undefined) maxEl.textContent = stats.max.toFixed(1);
            if (stats.avg !== undefined) avgEl.textContent = stats.avg.toFixed(1);
        }

        function updateCharts(metrics) {
            const timestamps = Array.from({length: 10}, (_, i) => {
                const date = new Date();
                date.setMinutes(date.getMinutes() - (9 - i));
                return date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
            });

            // CPUÂõæË°®
            updateChart('cpu-chart', cpuChart, timestamps, 
                       Array(10).fill(0).map(() => metrics.cpu_usage?.current || 0),
                       'CPU‰ΩøÁî®Áéá', '#3b82f6');

            // ÂÜÖÂ≠òÂõæË°®
            updateChart('memory-chart', memoryChart, timestamps,
                       Array(10).fill(0).map(() => metrics.memory_usage?.current || 0),
                       'ÂÜÖÂ≠ò‰ΩøÁî®Áéá', '#8b5cf6');
        }

        function updateChart(canvasId, chart, labels, data, label, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            if (chart) {
                chart.data.labels = labels;
                chart.data.datasets[0].data = data;
                chart.update();
            } else {
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: data,
                            borderColor: color,
                            backgroundColor: color + '20',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });

                if (canvasId === 'cpu-chart') cpuChart = chart;
                if (canvasId === 'memory-chart') memoryChart = chart;
            }
        }

        function updateAlerts(activeAlerts, recentAlerts) {
            const alertList = document.getElementById('alert-list');
            const alertsCount = document.getElementById('alerts-count');

            alertsCount.textContent = activeAlerts.length;

            if (activeAlerts.length === 0 && recentAlerts.length === 0) {
                alertList.innerHTML = '<p style="text-align: center; color: var(--text-muted);">ÊöÇÊó†ÂëäË≠¶</p>';
                return;
            }

            alertList.innerHTML = activeAlerts.map(alert => createAlertHTML(alert)).join('');
        }

        function createAlertHTML(alert) {
            const icons = {
                info: '‚ÑπÔ∏è',
                warning: '‚ö†Ô∏è',
                critical: 'üö®'
            };

            const time = new Date(alert.timestamp).toLocaleString('zh-CN');

            return `
                <div class="alert-item ${alert.severity}">
                    <div class="alert-icon">${icons[alert.severity]}</div>
                    <div class="alert-content">
                        <div class="alert-message">${alert.message}</div>
                        <div class="alert-time">${time}</div>
                    </div>
                    <div class="alert-actions">
                        <button class="btn-resolve" onclick="resolveAlert('${alert.id}')">Ëß£ÂÜ≥</button>
                    </div>
                </div>
            `;
        }

        async function resolveAlert(alertId) {
            try {
                const response = await fetch(`/api/monitoring/alerts/${alertId}/resolve`, {
                    method: 'POST'
                });

                if (response.ok) {
                    fetchDashboardData();
                }
            } catch (error) {
                console.error('Ëß£ÂÜ≥ÂëäË≠¶Â§±Ë¥•:', error);
            }
        }

        function updateHealthChecks(checks) {
            const checksContainer = document.getElementById('health-checks');

            checksContainer.innerHTML = checks.map(check => {
                const statusIcon = check.status === 'healthy' ? '‚úÖ' :
                                 check.status === 'unhealthy' ? '‚ùå' : '‚ö†Ô∏è';

                return `
                    <div class="health-check-item ${check.status}">
                        <div class="health-status ${check.status}"></div>
                        <div>
                            <div class="health-check-name">${check.name}</div>
                            <div class="health-check-message">${check.message}</div>
                        </div>
                        <div style="font-size: 24px;">${statusIcon}</div>
                    </div>
                `;
            }).join('');
        }

        function startAutoRefresh() {
            updateInterval = setInterval(fetchDashboardData, 30000); // 30ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
        }

        function stopAutoRefresh() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            fetchDashboardData();
            startAutoRefresh();
        });

        // È°µÈù¢Âç∏ËΩΩÊó∂ÂÅúÊ≠¢Âà∑Êñ∞
        window.addEventListener('beforeunload', stopAutoRefresh);
    </script>
</body>
</html>
