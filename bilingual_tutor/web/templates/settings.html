{% extends "base.html" %}

{% block title %}è®¾ç½® - åŒè¯­å¯¼å¸ˆç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="settings-page">
    <section class="page-header">
        <h1>âš™ï¸ å­¦ä¹ è®¾ç½®</h1>
        <p class="page-subtitle">ä¸ªæ€§åŒ–ä½ çš„å­¦ä¹ ä½“éªŒ</p>
    </section>

    <div class="settings-container">
        <!-- Profile Settings -->
        <section class="settings-section">
            <h2>ğŸ‘¤ ä¸ªäººä¿¡æ¯</h2>
            <div class="settings-card">
                <div class="setting-item">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="username" value="{{ user_id }}" disabled>
                </div>
            </div>
        </section>

        <!-- Language Level Settings -->
        <section class="settings-section">
            <h2>ğŸ“š è¯­è¨€æ°´å¹³</h2>
            <div class="settings-card">
                <div class="setting-item">
                    <label for="englishLevel">å½“å‰è‹±è¯­æ°´å¹³</label>
                    <select id="englishLevel">
                        <option value="CET-4">CET-4</option>
                        <option value="CET-5">CET-5</option>
                        <option value="CET-6">CET-6</option>
                        <option value="CET-6+">CET-6+</option>
                    </select>
                </div>

                <div class="setting-item">
                    <label for="japaneseLevel">å½“å‰æ—¥è¯­æ°´å¹³</label>
                    <select id="japaneseLevel">
                        <option value="N5">N5 (å…¥é—¨)</option>
                        <option value="N4">N4</option>
                        <option value="N3">N3</option>
                        <option value="N2">N2</option>
                        <option value="N1">N1</option>
                        <option value="N1+">N1+</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Study Time Settings -->
        <section class="settings-section">
            <h2>â° å­¦ä¹ æ—¶é—´</h2>
            <div class="settings-card">
                <div class="setting-item">
                    <label for="dailyTime">æ¯æ—¥å­¦ä¹ æ—¶é—´</label>
                    <div class="range-container">
                        <input type="range" id="dailyTime" min="30" max="120" value="60"
                            oninput="updateTimeDisplay(this.value)">
                        <span class="range-value" id="timeDisplay">60 åˆ†é’Ÿ</span>
                    </div>
                </div>

                <div class="setting-item">
                    <label>æ—¶é—´åˆ†é…</label>
                    <div class="time-distribution">
                        <div class="dist-item">
                            <span class="dist-icon">ğŸ”„</span>
                            <span class="dist-label">å¤ä¹ </span>
                            <span class="dist-value">20%</span>
                        </div>
                        <div class="dist-item">
                            <span class="dist-icon">ğŸ‡¬ğŸ‡§</span>
                            <span class="dist-label">è‹±è¯­</span>
                            <span class="dist-value">40%</span>
                        </div>
                        <div class="dist-item">
                            <span class="dist-icon">ğŸ‡¯ğŸ‡µ</span>
                            <span class="dist-label">æ—¥è¯­</span>
                            <span class="dist-value">40%</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Actions -->
        <div class="settings-actions">
            <button class="btn-secondary" onclick="resetSettings()">é‡ç½®</button>
            <button class="btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
        </div>

        <div class="settings-message" id="settingsMessage"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadCurrentSettings();
    });

    async function loadCurrentSettings() {
        try {
            const response = await fetch('/api/user/profile');
            const data = await response.json();

            if (data.success) {
                document.getElementById('englishLevel').value = data.profile.english_level;
                document.getElementById('japaneseLevel').value = data.profile.japanese_level;
                document.getElementById('dailyTime').value = data.profile.daily_study_time;
                updateTimeDisplay(data.profile.daily_study_time);
            }
        } catch (error) {
            console.error('Failed to load settings:', error);
        }
    }

    function updateTimeDisplay(value) {
        document.getElementById('timeDisplay').textContent = value + ' åˆ†é’Ÿ';
    }

    async function saveSettings() {
        const settings = {
            english_level: document.getElementById('englishLevel').value,
            japanese_level: document.getElementById('japaneseLevel').value,
            daily_time: document.getElementById('dailyTime').value
        };

        try {
            const response = await fetch('/api/settings/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            const data = await response.json();
            const msgEl = document.getElementById('settingsMessage');

            if (data.success) {
                msgEl.textContent = 'âœ… è®¾ç½®å·²ä¿å­˜';
                msgEl.className = 'settings-message success';
            } else {
                msgEl.textContent = 'âŒ ä¿å­˜å¤±è´¥: ' + data.message;
                msgEl.className = 'settings-message error';
            }

            setTimeout(() => { msgEl.textContent = ''; }, 3000);
        } catch (error) {
            console.error('Failed to save settings:', error);
        }
    }

    function resetSettings() {
        document.getElementById('englishLevel').value = 'CET-4';
        document.getElementById('japaneseLevel').value = 'N5';
        document.getElementById('dailyTime').value = 60;
        updateTimeDisplay(60);
    }
</script>
{% endblock %}